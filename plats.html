<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<title>Qook – Recettes</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{ 
  --bg:#f7f8fa; 
  --card:#fff; 
  --accent:#15b79a; 
  --accent-2:#0f9e85; 
  --muted:#6c7780; 
  --danger:#e74c3c; 
  --radius:18px;
}

* {
  box-sizing:border-box;
  -webkit-tap-highlight-color: transparent;
}

body,html {
  height:100%;
  margin:0;
  font-family:"Outfit",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  -webkit-font-smoothing: antialiased;
  -webkit-text-size-adjust: 100%;
}

body {
  background:linear-gradient(180deg,var(--bg),#eef4f8);
  color:#132a31;
  padding-bottom:calc(24px + env(safe-area-inset-bottom));
  padding-top:env(safe-area-inset-top);
}

.app {
  max-width:900px;
  margin:18px auto;
  padding:8px 16px;
}

header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:16px;
  flex-wrap:wrap;
}

.brand {
  display:flex;
  gap:12px;
  align-items:center;
  flex:1;
  min-width:250px;
}

.logo {
  width:48px;
  height:48px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  flex-shrink:0;
}

.logo img { 
  width:48px; 
  height:48px; 
  display:block; 
  border-radius:10px;
  object-fit:cover;
}

h1 {
  font-size:22px;
  margin:0;
  font-weight:700;
}

.hint {
  font-size:13px;
  color:var(--muted);
  margin:4px 0 0 0;
  line-height:1.4;
}

.card {
  background:var(--card);
  border-radius:12px;
  padding:16px;
  box-shadow:0 10px 30px rgba(17,36,45,0.05);
  border:1px solid rgba(15,25,30,0.03);
}

.categories-bar {
  display:flex;
  gap:10px;
  margin-bottom:16px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  padding-bottom:4px;
  scrollbar-width: none;
}

.categories-bar::-webkit-scrollbar {
  display:none;
}

.cat-btn {
  padding:10px 20px;
  border-radius:10px;
  border:none;
  background:#fafdff;
  color:var(--muted);
  font-weight:600;
  cursor:pointer;
  font-size:15px;
  transition:all 0.2s;
  white-space:nowrap;
  flex-shrink:0;
}

.cat-btn.active {
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;
  box-shadow:0 4px 12px rgba(21,183,154,0.25);
}

.recettes-list {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}

.recette-card {
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:0 3px 14px rgba(18,160,127,0.07);
  border:1.4px solid #e6f9f4;
  padding:0 0 12px 0;
  overflow:hidden;
  transition:all 0.2s;
}

.recette-card:active {
  transform:scale(0.98);
}

.recette-img {
  width:100%;
  height:180px;
  object-fit:cover;
  display:block;
}

.recette-content {
  padding:14px;
}

.recette-title {
  font-size:17px;
  font-weight:600;
  color:#13333a;
  margin:0 0 8px;
  line-height:1.3;
}

.recette-category {
  font-size:13px;
  color:var(--muted);
  font-weight:500;
  margin-bottom:6px;
}

.recette-macros {
  font-size:14px;
  color:var(--accent);
  margin-bottom:8px;
  font-weight:500;
}

.section-sub {
  color:var(--muted);
  font-size:13px;
  font-weight:600;
  letter-spacing:0.2px;
  margin:12px 0 6px 0;
}

.badge-fit {
  display:inline-block;
  margin:0 0 0 6px;
  padding:4px 10px;
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;
  font-size:11px;
  border-radius:18px;
  font-weight:600;
}

.badge-leger {
  background:linear-gradient(90deg,#cccccc 10%,#a0eed7 83%);
}

.badge-prot {
  background:linear-gradient(90deg,#fe877e 6%,#deefa6 90%);
}

.badge-objectif {
  background:linear-gradient(90deg,#15b79a,#7a70df);
}

ul.ingredient-list {
  margin:0 0 0 1.2em;
  padding:0;
  font-size:14px;
  line-height:1.5;
}

ul.ingredient-list li {
  margin-bottom:4px;
}

.steps-list {
  padding:0 0 0 1.2em;
  margin:0;
  list-style-type:decimal;
  font-size:14px;
  line-height:1.5;
}

.steps-list li {
  margin-bottom:6px;
}

.recette-actions {
  margin-top:14px;
  display:flex;
  gap:8px;
  align-items:center;
}

.btn {
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  border:none;
  font-weight:700;
  cursor:pointer;
  font-size:15px;
  transition:all 0.2s;
  flex:1;
}

.btn:active {
  transform:scale(0.95);
}

.btn.fav {
  font-size:24px;
  padding:10px 14px;
  background:#fafdff;
  color:var(--muted);
  border:1px solid #e6f9f4;
  flex:0;
}

.btn.fav.active {
  color:#fcc827;
  background:#fffbf0;
  border-color:#ffe8a0;
}

.ghost {
  background:transparent;
  color:var(--accent);
  border:1px solid var(--accent);
  padding:10px 16px;
  border-radius:10px;
  text-decoration:none;
  font-weight:600;
  font-size:15px;
  transition:all 0.2s;
}

.ghost:active {
  transform:scale(0.95);
}

.goal-notice {
  color:#0f9e85;
  font-weight:600;
  background:#e6f9f4;
  border-radius:10px;
  padding:12px 16px;
  margin-bottom:16px;
  font-size:14px;
  border:1px solid #c0e5dd;
  line-height:1.5;
}

.recette-temps { 
  font-size:13px;
  color:var(--accent-2);
  font-weight:600;
  margin-bottom:8px;
  background:#fafdff;
  border-radius:6px;
  padding:4px 10px;
  display:inline-block;
}

#searchBar {
  width:100%;
  padding:12px 16px;
  margin-bottom:16px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:16px;
  background:#fff;
  -webkit-appearance:none;
}

#searchBar:focus {
  outline:none;
  border-color:var(--accent);
}

.suggestions-carousel {
  display:flex;
  overflow-x:auto;
  gap:12px;
  margin-bottom:16px;
  padding-bottom:8px;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling:touch;
  scrollbar-width: none;
}

.suggestions-carousel::-webkit-scrollbar {
  display:none;
}

.suggestion-card {
  flex:0 0 auto;
  width:160px;
  background:var(--card);
  border-radius:12px;
  box-shadow:0 3px 14px rgba(18,160,127,0.07);
  border:1.4px solid #e6f9f4;
  cursor:pointer;
  transition:all 0.2s;
  overflow:hidden;
}

.suggestion-card:active {
  transform:scale(0.95);
}

.suggestion-card img {
  width:100%;
  height:100px;
  object-fit:cover;
  display:block;
}

.suggestion-card .suggestion-title {
  padding:10px;
  font-weight:600;
  font-size:14px;
  color:#13333a;
  line-height:1.3;
}

#loader {
  width:56px;
  height:56px;
  border-radius:50%;
  border:6px solid #e7f8f3;
  border-top:6px solid var(--accent);
  animation: spin 0.9s linear infinite;
  margin:48px auto;
  display:none;
}

@keyframes spin {
  to { transform:rotate(360deg); }
}

/* iPhone et mobile */
@media (max-width:768px) {
  .app {
    padding:8px 12px;
    margin:12px auto;
  }

  .recettes-list {
    grid-template-columns:1fr;
    gap:14px;
  }

  .recette-img {
    height:200px;
  }

  h1 {
    font-size:20px;
  }

  .hint {
    font-size:12px;
  }

  header {
    gap:10px;
  }

  .brand {
    min-width:auto;
  }
}

@media (max-width:390px) {
  .recette-img {
    height:180px;
  }

  .recette-title {
    font-size:16px;
  }

  .btn {
    font-size:14px;
    padding:10px 14px;
  }

  .card {
    padding:12px;
  }

  .suggestion-card {
    width:140px;
  }
}

/* Safe area pour iPhone avec encoche */
@supports (padding: max(0px)) {
  body {
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
  }
}
</style>
</head>
<body>
<div class="app">
<header>
<div class="brand">
<div class="logo" aria-hidden="true" title="Nutrition">
<img src="https://firebasestorage.googleapis.com/v0/b/justfit-bed28.firebasestorage.app/o/logoapp.jpg?alt=media&token=85987921-9c3a-445a-979d-9662c2d17e93" alt="Logo Qook" />
</div>
<div>
<h1>Recettes</h1>
<p class="hint">Retrouve ici un large choix de recettes avec leur préparation</p>
</div>
</div>
<div style="display:flex;gap:8px">
<a href="home.html" class="ghost">Retour</a>
</div>
</header>

<main>
<section class="card">
<div id="userGoalNotice" class="goal-notice" style="display:none"></div>
<input type="text" id="searchBar" placeholder="Rechercher un plat..."/>
<div class="suggestions-carousel" id="suggestionsCarousel"></div>
<div class="categories-bar" id="categoriesBar"></div>
<div class="recettes-list" id="recettesList"></div>
<div id="loader"></div>
</section>
</main>
</div>

<script>
// Fonctions de favoris et filtre
function getFavList(){
  try{
    return JSON.parse(localStorage.getItem('sn_v2_fav_recipes')||'[]');
  }catch(e){
    return[];
  }
}

function setFavList(arr){
  try{
    localStorage.setItem('sn_v2_fav_recipes',JSON.stringify(arr));
  }catch(e){}
}

function isFav(nom){
  return getFavList().includes(nom);
}

function toggleFav(nom){
  let favs=getFavList();
  if(favs.includes(nom)){
    favs=favs.filter(f=>f!==nom);
  }else{
    favs.push(nom);
  }
  setFavList(favs);
  renderRecettesList(currentPlats,currentCat,document.getElementById('searchBar').value);
}

function filtreNonVeg(list){
  return list.filter(r=>
    !(r.categorie&&r.categorie.toLowerCase().includes("végétarien")||r.categorie.toLowerCase().includes("vegan"))&&
    !(r.nom&&r.nom.toLowerCase().includes("vegan"))&&
    !(r.type&&(r.type=="vegan"||r.type=="vegetarien"||r.type=="plat végétarien"))&&
    typeof r.image=="string"&&r.image.length>0
  );
}

function getUserGoal(){
  let goal=2000;
  try{
    const profileStr=localStorage.getItem('sn_v2_profile');
    if(profileStr){
      const profile=JSON.parse(profileStr);
      if(profile.goalCalories&&profile.goalCalories>100){
        goal=profile.goalCalories;
      }
    }
  }catch(e){}
  return goal;
}

let userCalGoal=getUserGoal();
document.getElementById("userGoalNotice").style.display="block";
document.getElementById("userGoalNotice").innerHTML=`Ton objectif calorique est <strong>${userCalGoal} kcal</strong>.<br>Les plats affichés sont adaptés à ton besoin!`;

let currentCat=null,currentPlats=null;

function renderCategoriesBar(categories,activeType){
  const bar=document.getElementById('categoriesBar');
  bar.innerHTML='';
  categories.forEach(cat=>{
    const btn=document.createElement('button');
    btn.className='cat-btn'+(activeType===cat.type?' active':'');
    btn.dataset.type=cat.type;
    btn.textContent=cat.label;
    btn.onclick=()=>{
      currentCat=btn.dataset.type;
      renderRecettesList(currentPlats,currentCat,document.getElementById('searchBar').value);
      renderCategoriesBar(categories,currentCat);
    };
    bar.appendChild(btn);
  });
}

function renderSuggestions(plats){
  const carousel=document.getElementById('suggestionsCarousel');
  carousel.innerHTML='';
  plats.slice(0,10).forEach(p=>{
    const card=document.createElement('div');
    card.className='suggestion-card';
    card.onclick=()=>scrollToRecette(p.nom);
    card.innerHTML=`<img src="${p.image}" alt="${p.nom}"/><div class="suggestion-title">${p.nom}</div>`;
    carousel.appendChild(card);
  });
}

function scrollToRecette(nom){
  const el=[...document.querySelectorAll('.recette-title')].find(e=>e.textContent.includes(nom));
  if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
}

function badgeFor(rec,goal){
  if(!rec.macros)return"";
  const cal=rec.macros.cal;
  let badges=[];
  if(rec.type=="plat"&&cal>=goal*0.2&&cal<=goal*0.5)
    badges.push(`<span class="badge-fit badge-objectif">Objectif ~${Math.round(100*cal/goal)}%</span>`);
  if(cal<=110&&(rec.type=="entree"||rec.type=="dessert"))
    badges.push(`<span class="badge-fit badge-leger">Léger</span>`);
  if(rec.macros.p&&rec.macros.p>=20)
    badges.push(`<span class="badge-fit badge-prot">Protéiné</span>`);
  if(rec.type=="boisson")
    badges.push(`<span class="badge-fit badge-leger">Boisson</span>`);
  return badges.join('');
}

function renderRecettesList(list,typeFilter='',search=''){
  const goal=userCalGoal;
  const plats=filtreNonVeg(list);
  currentPlats=plats;
  const container=document.getElementById('recettesList');
  container.innerHTML='';
  
  let filtered=plats;
  if(typeFilter)filtered=filtered.filter(r=>r.type===typeFilter);
  if(search)filtered=filtered.filter(r=>r.nom.toLowerCase().includes(search.toLowerCase()));
  
  filtered.forEach(recette=>{
    const macros=recette.macros?`${recette.macros.cal}kcal • ${recette.macros.p}g P • ${recette.macros.c}g C • ${recette.macros.f}g L`:'';
    const favActive=isFav(recette.nom)?'active':'';
    const temps=recette.temps?`<span class="recette-temps">⏱ ${recette.temps} min</span>`:'';
    
    const card=document.createElement('div');
    card.className='recette-card';
    card.innerHTML=`
      <img src="${recette.image}" alt="${recette.nom}" class="recette-img" loading="lazy"/>
      <div class="recette-content">
        <div class="recette-title">${recette.nom} ${badgeFor(recette,goal)}</div>
        <div class="recette-category">${recette.categorie}</div>
        ${temps}
        <div class="recette-macros">${macros}</div>
        <div class="section-sub">Ingrédients :</div>
        <ul class="ingredient-list">${recette.ingredients.map(ing=>`<li>${ing}</li>`).join('')}</ul>
        <div class="section-sub">Préparation :</div>
        <ol class="steps-list">${recette.etapes.map(e=>`<li>${e}</li>`).join('')}</ol>
        <div class="recette-actions">
          <button class="btn" onclick="copyRecette('${recette.nom}')">Copier recette</button>
          <button class="btn fav ${favActive}" onclick="toggleFav('${recette.nom}')" title="Favoris">${favActive?"★":"☆"}</button>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
  
  renderSuggestions(filtered);
}

window.copyRecette=function(nom){
  const recette=currentPlats.find(r=>r.nom===nom);
  if(!recette)return;
  const text=`${recette.nom}\nCatégorie: ${recette.categorie}\nMacros: ${recette.macros?.cal}kcal, ${recette.macros?.p}g P, ${recette.macros?.c}g C, ${recette.macros?.f}g L\nTemps: ${recette.temps||'-'} min\n\nIngrédients:\n- ${recette.ingredients.join('\n- ')}\n\nPréparation:\n${recette.etapes.map((e,i)=>`${i+1}. ${e}`).join('\n')}`;
  navigator.clipboard.writeText(text).then(()=>alert("✅ Recette copiée !")).catch(()=>alert("❌ Erreur lors de la copie"));
};

// Recherche
document.getElementById('searchBar').addEventListener('input',e=>renderRecettesList(currentPlats,currentCat,e.target.value));

// Chargement JSON
document.getElementById('recettesList').style.display='none';
document.getElementById('loader').style.display='block';

fetch('recettes.json')
  .then(resp=>resp.json())
  .then(data=>{
    const recettes=filtreNonVeg(data);
    currentPlats=recettes;
    const categories=Object.entries(recettes.reduce((acc,r)=>{
      acc[r.categorie]=r.type;
      return acc;
    },{})).map(([label,type])=>({label,type}));
    currentCat=categories[0]?categories[0].type:null;
    renderCategoriesBar(categories,currentCat);
    renderRecettesList(recettes,currentCat);
    document.getElementById('recettesList').style.display='';
    document.getElementById('loader').style.display='none';
  })
  .catch(()=>{
    document.getElementById('loader').style.display='none';
    document.getElementById('recettesList').style.display='';
    document.getElementById('recettesList').innerHTML="<div style='color:var(--danger);text-align:center;font-size:1.2em;padding:40px 20px;'>❌ Impossible de charger les recettes.</div>";
  });
</script>
</body>
</html>
