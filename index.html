<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EatWise</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- ZXing (scan barcode) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <!-- Ic√¥ne pour Android et navigateur -->
  <link rel="icon" type="image/png" sizes="192x192" href="https://firebasestorage.googleapis.com/v0/b/justfit-bed28.firebasestorage.app/o/logoapp.jpg?alt=media&token=85987921-9c3a-445a-979d-9662c2d17e93">
  <!-- Ic√¥ne pour iOS (√©cran d'accueil) -->
  <link rel="apple-touch-icon" href="https://firebasestorage.googleapis.com/v0/b/justfit-bed28.firebasestorage.app/o/logoapp.jpg?alt=media&token=85987921-9c3a-445a-979d-9662c2d17e93">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="EatWise">
  <meta name="theme-color" content="#ffffff">
  <script src="base-plats-complet.js"></script>
  <style>
    :root{ --bg:#f6f8fb; --card:#fff; --accent:#15b79a; --accent-2:#0f9e85; --muted:#6c7780; --danger:#e74c3c; --radius:14px; --glass: rgba(255,255,255,0.6) }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:"Outfit",system-ui, -apple-system, "Segoe UI", Roboto, Arial; -webkit-font-smoothing:antialiased}
    body{background:linear-gradient(180deg,var(--bg),#eef4f8); color:#132a31; padding-bottom:120px}
    .app{max-width:980px; margin:14px auto; padding:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:56px;height:56px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
     
      box-shadow:0 10px 30px rgba(18,160,127,0.12);
    }
    .logo img{ width:50px; height:50px; display:block; border-radius:10px;}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;font-size:12px;color:var(--muted)}
    .container{display:grid;grid-template-columns:1fr;gap:14px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 10px 30px rgba(17,36,45,0.05);border:1px solid rgba(15,25,30,0.03)}
    /* Summary + date layout - improved */
    .top-row { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; flex:1; min-width:260px}
    .summary-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfffd)}
    .summary-item .icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(21,183,154,0.09);color:var(--accent-2);font-weight:700}
    .summary-item small{display:block;color:var(--muted);font-size:12px}
    .summary-item strong{display:block;font-size:16px;margin-top:2px}
    .date-card{min-width:220px; max-width:320px; background:linear-gradient(180deg,rgba(255,255,255,0.95),var(--card)); padding:12px; border-radius:12px; border:1px solid rgba(15,25,30,0.03)}
    .date-card .date-row{display:flex; gap:8px; align-items:center;}
    .date-card .date-row input{flex:1; padding:10px; border-radius:10px; border:1px solid rgba(15,25,30,0.06); background:#fff}
    .date-card .day-totals{margin-top:10px; display:flex; flex-direction:column; gap:6px; color:var(--muted)}
    .date-card .day-totals .big{font-weight:700; color:#13333a}
    /* Calendar */
    .calendar {
      margin-top:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .calendar .panel {
      min-width:260px;
      max-width:320px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), var(--card));
      border-radius:12px;
      padding:10px;
      border:1px solid rgba(15,25,30,0.03);
      box-shadow:0 8px 24px rgba(10,20,30,0.04);
    }
    .cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cal-header button{background:transparent;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--muted)}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-grid .dow{font-size:12px;color:var(--muted);text-align:center}
    .day{
      height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer;
      font-size:14px; color:#15303a;
    }
    .day.other{ color:rgba(20,30,40,0.25) }
    .day.today{ border:1px dashed rgba(20,30,40,0.08) }
    .day.selected{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:white; box-shadow:0 8px 20px rgba(18,160,127,0.12) }
    .day.has-meal::after{ content:''; width:6px; height:6px; background:var(--accent-2); border-radius:999px; position:relative; top:6px; display:block; margin-top:6px; opacity:0.9 }
    /* Form & list */
    form{display:flex;flex-direction:column;gap:10px}
    label{font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="number"],select{
      width:100%;padding:12px;border-radius:10px;border:1px solid rgba(15,25,30,0.06);font-size:14px;background:#fff
    }
    input:focus,select:focus{outline:none;box-shadow:0 8px 24px rgba(18,160,127,0.08);border-color:var(--accent-2)}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:12px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(15,25,30,0.04)}
    .meals-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .meal-item{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px;border-radius:10px;background:#fbfeff;border:1px solid rgba(12,25,30,0.03)}
    .meal-left{display:flex;gap:10px;align-items:center;min-width:0}
    .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#ffd6a5,#ff8a7d);display:flex;align-items:center;justify-content:center;color:#2b2b2b;font-weight:700}
    .meal-meta strong{display:block;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meal-meta small{display:block;color:var(--muted)}
    .meal-actions{display:flex;gap:8px;align-items:center}
    .icon-btn{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
    .icon-btn.del{color:var(--danger);background:linear-gradient(180deg, rgba(231,76,60,0.06), rgba(231,76,60,0.02))}
    /* Quick stats */
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .stat{display:flex;flex-direction:column;gap:6px}
    .progress-wrap{background:#f1f6f6;border-radius:999px;overflow:hidden;height:12px}
    .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .3s}
    /* Scanner modal */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:120; background:rgba(10,15,20,0.45); }
    .modal.active { display:flex; }
    .scanner-sheet { width:calc(100% - 40px); max-width:680px; background:#fff; border-radius:12px; padding:12px; box-shadow:0 30px 80px rgba(10,20,30,0.3); }
    .scanner-video { width:100%; border-radius:8px; background:#000; height:320px; object-fit:cover; }
    .scanner-controls{display:flex;gap:8px;margin-top:8px}
    /* Nav - restored older icons + scanner icon */
    .nav-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;width:calc(100% - 22px);max-width:720px;height:68px;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.9));display:flex;justify-content:space-around;align-items:center;border-radius:999px;box-shadow:0 18px 40px rgba(12,30,40,0.12);padding:8px;z-index:70}
    .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;color:var(--muted);background:transparent;border:none;padding:8px 12px;border-radius:12px;cursor:pointer;font-size:12px}
    .nav-item.active{color:var(--accent-2);background:linear-gradient(180deg, rgba(21,183,154,0.06), rgba(21,183,154,0.03))}
    @media (max-width:720px){ .summary-grid{grid-template-columns:repeat(2,1fr)} .calendar .panel{min-width:100%; max-width:100%} }
    /* --- DASHBOARD UI ENHANCEMENT (summary-grid tr√®s pouss√©) --- */
    .summary-grid {
      
      border-radius: 22px;
      padding: 18px 12px 12px 12px;
      margin-bottom: 8px;
      gap: 18px;
      position: relative;
    }
    .summary-item {
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 18px 10px 14px 10px;
      transition: transform 0.18s, box-shadow 0.18s, background 0.18s;
      cursor: pointer;
      border: 1.5px solid #00000009;
      position: relative;
      overflow: hidden;
    }
    .summary-item:hover {
      transform: translateY(-4px) scale(1.045);
      box-shadow: 0 8px 32px rgba(21,183,154,0.18), 0 1.5px 0 #b6f2e2;
      background: linear-gradient(120deg,#e6f9f4 80%,#fff 100%);
      border-color: #b6f2e2;
    }
    .summary-item .icon {
      width: 54px;
      height: 54px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg,#e6f9f4 60%,#fff 100%);
      color: #15b79a;
      font-size: 2.1em;
      font-weight: 700;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(21,183,154,0.08);
    }
    .summary-item small {
      display: block;
      color: #6c7780;
      font-size: 13px;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }
    .summary-item strong {
      display: block;
      font-size: 22px;
      margin-top: 2px;
      color: #13333a;
      letter-spacing: 0.5px;
      font-weight: 700;
      text-shadow: 0 1px 0 #e6f9f4;
    }
    @media (max-width: 720px) {
      .summary-grid { grid-template-columns: 1fr 1fr; gap: 12px; padding: 10px 4px; }
      .summary-item { padding: 12px 6px 10px 6px; }
      .summary-item .icon { width: 40px; height: 40px; font-size: 1.3em; }
      .summary-item strong { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Suivi Nutrition ‚Äî Accueil">
    
    <main class="container" id="main">
      <section class="card" aria-labelledby="dashTitle">
        <h2 id="dashTitle" style="margin:0 0 8px 0;color:#13333a">Tableau de bord</h2>

        <div class="top-row">
          <div style="width:100%">
            <div class="summary-grid" aria-hidden="false">
              <div class="summary-item">
                <div class="icon" aria-hidden="true">üçΩÔ∏è</div>
                <div><small>Repas</small><strong id="totalMeals">0</strong></div>
              </div>

              <div class="summary-item">
                <div class="icon" aria-hidden="true">üî•</div>
                <div><small>Calories</small><strong id="totalCalories">0 kcal</strong></div>
              </div>

              <div class="summary-item">
                <div class="icon" aria-hidden="true">üí™</div>
                <div><small>Prot√©ines</small><strong id="totalProteines">0 g</strong></div>
              </div>

              <div class="summary-item">
                <div class="icon" aria-hidden="true">üç¨</div>
                <div><small>Glucides</small><strong id="totalGlucides">0 g</strong></div>
              </div>
            </div>

            <!-- Dashboard progress (new) -->
            <div style="margin-top:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:13px;color:var(--muted)">Objectif calories</div>
                <div id="dashboardPercent" style="font-size:13px;color:var(--muted)">0%</div>
              </div>
              <div class="progress-wrap" style="margin-top:8px;height:12px;border-radius:10px;">
                <div id="dashboardProgress" class="progress-bar" style="height:100%;border-radius:10px;width:0%"></div>
              </div>
            </div>
          </div>

          <div class="date-card" aria-hidden="false">
            <label style="font-size:13px;color:var(--muted);margin-bottom:6px;display:block">Date s√©lectionn√©e</label>
            <div class="date-row">
              <input id="selectedDateInput" type="date" />
              <button id="todayBtn" class="btn ghost">Aujourd'hui</button>
            </div>

            <div class="day-totals" aria-live="polite">
              <div style="font-size:13px;color:var(--muted)">Journ√©e</div>
              <div class="big" id="selectedDateLabel">‚Äî</div>
              <div style="display:flex;justify-content:space-between;margin-top:6px;color:var(--muted)"><div>Total</div><div id="statusCalories">0 kcal</div></div>
              <div style="display:flex;justify-content:space-between;color:var(--muted)"><div>Prot√©ines</div><div id="totalProteinesShort">0 g</div></div>
              <div style="display:flex;justify-content:space-between;color:var(--muted)"><div>Glucides</div><div id="totalGlucidesShort">0 g</div></div>

              <!-- Scanner trigger -->
              <div style="margin-top:10px">
                <button id="openScannerBtn" class="btn ghost" type="button">Scanner un code-barres</button>
                <div style="margin-top:6px;color:font-size 12px">Vous pouvez scanner un code-barres pour pr√©-remplir l'aliment.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Calendar -->
        <div class="calendar" id="calendarWrap">
          <div class="panel" id="monthPanel">
            <div class="cal-header">
              <button id="prevMonth" title="Mois pr√©c√©dent">‚Äπ</button>
              <div style="font-weight:700" id="monthLabel">D√©cembre 2024</div>
              <button id="nextMonth" title="Mois suivant">‚Ä∫</button>
            </div>
            <div class="cal-grid" id="dowRow">
              <div class="dow">Lun</div><div class="dow">Mar</div><div class="dow">Mer</div><div class="dow">Jeu</div><div class="dow">Ven</div><div class="dow">Sam</div><div class="dow">Dim</div>
            </div>
            <div class="cal-grid" id="daysGrid" style="margin-top:8px"></div>
          </div>

          <div class="panel" style="flex:1; min-width:260px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <!-- 'Ajouter / Voir' label removed as requested -->
                <div style="font-weight:700" id="selectedDateLabelShort">‚Äî</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:12px;color:var(--muted)">Totaux</div>
                <div style="font-weight:700" id="dayTotalsShort">0 kcal ‚Ä¢ 0 g P ‚Ä¢ 0 g C</div>
              </div>
            </div>

            <!-- Heading 'Ajouter un repas' removed; form kept -->
            <form id="mealForm" autocomplete="off">
              <label for="aliment">Aliment</label>
              <input id="aliment" name="aliment" type="text" placeholder="Ex: Poulet grill√©" required />

              <div class="row">
                <div class="col"><label for="categorie">Cat√©gorie</label>
                  <select id="categorie" name="categorie"><option>Entr√©e</option><option selected>Plat</option><option>Dessert</option><option>Snack</option></select>
                </div>
                <div class="col"><label for="quantite">Quantit√©</label><input id="quantite" name="quantite" type="text" placeholder="Ex: 150 g" /></div>
              </div>

              <div class="row">
                <div class="col"><label for="calories">Calories (kcal)</label><input id="calories" name="calories" type="number" min="0" /></div>
                <div class="col"><label for="proteines">Prot√©ines (g)</label><input id="proteines" name="proteines" type="number" min="0" step="0.1" /></div>
              </div>

              <div class="row">
                <div class="col"><label for="glucides">Glucides (g)</label><input id="glucides" name="glucides" type="number" min="0" step="0.1" /></div>
                <div class="col"><label for="lipides">Lipides (g)</label><input id="lipides" name="lipides" type="number" min="0" step="0.1" /></div>
              </div>

              <div style="display:flex;gap:8px;margin-top:6px">
                <button type="submit" class="btn" id="addBtn">Ajouter</button>
                <button type="button" id="clearBtn" class="btn ghost">Effacer</button>
              </div>
            </form>

            <div style="margin-top:12px">
              <h4 style="margin:0 0 8px 0">Repas du jour</h4>
              <div id="mealsContainer" class="meals-list" aria-live="polite"></div>
              <div id="emptyState" style="color:var(--muted);margin-top:8px;display:none">Aucun repas pour cette date ‚Äî ajoutez-en un.</div>
            </div>
          </div>
        </div>

      </section>

      <section class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0;color:#13333a">Aper√ßu rapides</h3>
        <div class="grid-2">
          <div>
            <small style="color:var(--muted)">Total consomm√© (jour)</small>
            <div style="font-weight:700;margin-top:6px" id="statusCalories">0 kcal</div>
            <div class="progress-wrap" style="margin-top:8px"><div id="progressBar" class="progress-bar"></div></div>
            <div style="margin-top:8px;color:var(--muted)">Atteint <strong id="percentReached">0%</strong></div>
          </div>

          <div>
            <small style="color:var(--muted)">Totaux macros (jour)</small>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <div style="display:flex;justify-content:space-between;color:#13333a"><div>Prot√©ines</div><div id="totalProteinesShort2">0 g</div></div>
              <div style="display:flex;justify-content:space-between;color:#13333a"><div>Glucides</div><div id="totalGlucidesShort2">0 g</div></div>
              <div style="display:flex;justify-content:space-between;color:#13333a"><div>Lipides</div><div id="totalLipidesShort">0 g</div></div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Scanner modal -->
  <div id="scannerModal" class="modal" aria-hidden="true">
    <div class="scanner-sheet" role="dialog" aria-modal="true" aria-labelledby="scannerTitle">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="scannerTitle" style="margin:0">Scanner un code-barres</h3>
        <div>
          <button id="closeScannerBtn" class="btn ghost" type="button">Fermer</button>
        </div>
      </div>

      <video id="scannerVideo" class="scanner-video" autoplay muted playsinline></video>
      <div style="margin-top:8px;color:var(--muted);font-size:13px">Le scanner utilisera votre cam√©ra. Autorisez l'acc√®s si demand√©.</div>

      <div class="scanner-controls">
        <select id="videoSelect" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(15,25,30,0.06)"></select>
        <button id="startScannerBtn" class="btn" type="button">D√©marrer</button>
        <button id="stopScannerBtn" class="btn ghost" type="button">Arr√™ter</button>
      </div>

      <div style="margin-top:10px">
        <label style="font-size:13px;color:var(--muted);">R√©sultat</label>
        <div id="scanResult" style="padding:8px;border-radius:8px;background:#f6f8fa;border:1px solid rgba(15,25,30,0.03)">‚Äî</div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">Si le scan trouve un code, vous pouvez l'ins√©rer dans le champ "Aliment" ou laisser l'application pr√©-remplir via OpenFoodFacts.</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="useScanBtn" class="btn" type="button">Ins√©rer dans Aliment</button>
          <input id="uploadImage" type="file" accept="image/*" style="display:none" />
          <button id="uploadBtn" class="btn ghost" type="button">Scanner depuis image</button>
        </div>
      </div>
    </div>
  </div>

  <nav class="nav-bar" role="navigation" aria-label="Navigation">
    <!-- Restored older SVG icons -->
    <button class="nav-item active" data-page="dashboard" aria-label="Dashboard">
      <div style="display:flex;align-items:center;justify-content:center">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M3 13.5V21H10V13.5H3Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 3.5V21H21V3.5H14Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <span>Accueil</span>
    </button>

    <button class="nav-item" data-page="add" aria-label="Ajouter">
      <div style="display:flex;align-items:center;justify-content:center">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 5V19" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M5 12H19" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </div>
      <span>Ajouter</span>
    </button>

    <button class="nav-item" data-page="scan" aria-label="Scanner">
      <div style="display:flex;align-items:center;justify-content:center">
        <!-- Barcode icon -->
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M2 7H4V17H2V7Z" fill="currentColor"/>
          <path d="M6 7H7V17H6V7Z" fill="currentColor"/>
          <path d="M9 7H10V17H9V7Z" fill="currentColor"/>
          <path d="M12 7H13V17H12V7Z" fill="currentColor"/>
          <path d="M15 7H16V17H15V7Z" fill="currentColor"/>
          <path d="M18 7H20V17H18V7Z" fill="currentColor"/>
        </svg>
      </div>
      <span>Scanner</span>
    </button>

    <button class="nav-item" data-page="account" aria-label="Compte">
      <div style="display:flex;align-items:center;justify-content:center">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M20 21V19C20 16.7909 18.2091 15 16 15H8C5.79086 15 4 16.7909 4 19V21" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <span>Compte</span>
    </button>
  </nav>

<script>
/* Storage keys */
const STORAGE_KEY = 'sn_v2_meals';
const PROFILE_KEY = 'sn_v2_profile';

/* Load meals (migrate if needed) */
let meals = [];
try{
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    meals = JSON.parse(raw);
    const todayISO = (new Date()).toISOString().slice(0,10);
    let migrated = false;
    meals = meals.map(m => {
      if(!m.date){ migrated = true; return Object.assign({}, m, {date: todayISO}); }
      return m;
    });
    if(migrated) localStorage.setItem(STORAGE_KEY, JSON.stringify(meals));
  }
}catch(e){ console.warn('Could not read meals', e); meals = []; }

/* Load profile for goal */
let profile = { goalCalories:2000 };
try{
  const p = localStorage.getItem(PROFILE_KEY);
  if(p) profile = Object.assign(profile, JSON.parse(p));
}catch(e){}

/* DOM refs */
const selectedDateInput = document.getElementById('selectedDateInput');
const selectedDateLabel = document.getElementById('selectedDateLabel');
const selectedDateLabelShort = document.getElementById('selectedDateLabelShort');
const totalMealsEl = document.getElementById('totalMeals');
const totalCaloriesEl = document.getElementById('totalCalories');
const totalProteinesEl = document.getElementById('totalProteines');
const totalGlucidesEl = document.getElementById('totalGlucides');
const mealsContainer = document.getElementById('mealsContainer');
const emptyState = document.getElementById('emptyState');
const statusCalories = document.getElementById('statusCalories');
const progressBar = document.getElementById('progressBar');
const percentReached = document.getElementById('percentReached');
const totalProteinesShort = document.getElementById('totalProteinesShort');
const totalGlucidesShort = document.getElementById('totalGlucidesShort');
const totalProteinesShort2 = document.getElementById('totalProteinesShort2');
const totalGlucidesShort2 = document.getElementById('totalGlucidesShort2');
const totalLipidesShort = document.getElementById('totalLipidesShort');
const dayTotalsShort = document.getElementById('dayTotalsShort');
const monthLabel = document.getElementById('monthLabel');
const daysGrid = document.getElementById('daysGrid');
const prevMonthBtn = document.getElementById('prevMonth');
const nextMonthBtn = document.getElementById('nextMonth');
const mealForm = document.getElementById('mealForm');
const addBtn = document.getElementById('addBtn');
const clearBtn = document.getElementById('clearBtn');

const dashboardProgress = document.getElementById('dashboardProgress');
const dashboardPercent = document.getElementById('dashboardPercent');

let selectedDate = null;
let viewYear = null;
let viewMonth = null;

/* Barcode lookup state */
let lastScannedBarcode = '';
let lastProduct = null; // product info from OpenFoodFacts

/* Utilities - use local-date based ISO to avoid UTC shift */
function toISODate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function parseISO(s){
  // s expected 'YYYY-MM-DD' -> create local date at midnight
  if(!s) return new Date();
  const parts = s.split('-').map(Number);
  return new Date(parts[0], parts[1]-1, parts[2]);
}
function formatDateLabel(iso){ const d = parseISO(iso); return d.toLocaleDateString(undefined, {weekday:'long', day:'numeric', month:'long', year:'numeric'}); }

/* Init selectedDate (force to today's local date when page loads) */
function initSelectedDate(){
  const today = toISODate(new Date());
  const inputVal = selectedDateInput.value;
  if(inputVal && /^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    selectedDate = inputVal;
  } else {
    selectedDate = today;
    selectedDateInput.value = selectedDate;
  }
  const dt = parseISO(selectedDate);
  viewYear = dt.getFullYear();
  viewMonth = dt.getMonth();
}

/* Save meals */
function saveMeals(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(meals)); }catch(e){ console.warn('save failed', e); } }

/* Totals for date */
function totalsForDate(isoDate){
  const t = meals.filter(m => m.date === isoDate).reduce((s,m)=>{
    s.cal += Number(m.calories||0);
    s.p += Number(m.proteines||0);
    s.c += Number(m.glucides||0);
    s.f += Number(m.lipides||0);
    s.count += 1;
    return s;
  }, {cal:0,p:0,c:0,f:0,count:0});
  return t;
}

/* Days with meals in month */
function daysWithMealsInMonth(year, month){
  const out = {};
  meals.forEach(m => {
    if(!m.date) return;
    const d = parseISO(m.date);
    if(d.getFullYear() === year && d.getMonth() === month){
      out[m.date] = (out[m.date] || 0) + 1;
    }
  });
  return out;
}

/* --- OpenFoodFacts lookup helpers --- */
async function lookupBarcodeOpenFoodFacts(barcode){
  // Returns {found: bool, product: {...}} or throws
  const url = `https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(barcode)}.json`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if(data.status === 1 && data.product){
      return {found:true, product: data.product};
    } else {
      return {found:false};
    }
  }catch(e){
    console.warn('lookup error', e);
    return {found:false, error: e};
  }
}

function parseNutriments(product){
  // Try many keys; return object with calories (per 100g), proteins, carbs, fats, serving_grams (if any)
  const n = product.nutriments || {};
  let kcal = null;
  if(n['energy-kcal_100g']) kcal = Number(n['energy-kcal_100g']);
  else if(n['energy-kcal']) kcal = Number(n['energy-kcal']);
  else if(n['energy_100g']) { // usually in kJ
    const kj = Number(n['energy_100g']);
    if(!isNaN(kj)) kcal = Math.round(kj / 4.184);
  }
  const proteins = Number(n['proteins_100g'] || n['protein_100g'] || 0);
  const carbs = Number(n['carbohydrates_100g'] || n['carbs_100g'] || 0);
  const fats = Number(n['fat_100g'] || n['lipids_100g'] || 0);

  // try parse serving_size like "200g"
  let servingGrams = null;
  const ss = product.serving_size || product.serving_size_string || '';
  if(ss){
    const m = ss.match(/([0-9]+(?:[.,][0-9]+)?)\s*g/i);
    if(m) servingGrams = Number(m[1].replace(',', '.'));
  }

  return {kcal_per_100g: isNaN(kcal)? null : kcal, proteins_100g: isNaN(proteins)?0:proteins, carbs_100g: isNaN(carbs)?0:carbs, fats_100g: isNaN(fats)?0:fats, servingGrams};
}

function applyProductToForm(product){
  // Fill aliment and nutrition fields if data available.
  if(!product) return;
  const name = product.product_name || product.generic_name || product.brands || '';
  if(name) document.getElementById('aliment').value = name;

  const nutr = parseNutriments(product);
  // If we have per 100g values and a serving size, fill with per-serving values; otherwise fill per 100g (user can adjust quantity)
  if(nutr.kcal_per_100g != null){
    if(nutr.servingGrams){
      const factor = nutr.servingGrams / 100;
      document.getElementById('calories').value = Math.round(nutr.kcal_per_100g * factor);
      document.getElementById('proteines').value = +(nutr.proteins_100g * factor).toFixed(1);
      document.getElementById('glucides').value = +(nutr.carbs_100g * factor).toFixed(1);
      document.getElementById('lipides').value = +(nutr.fats_100g * factor).toFixed(1);
      // set quantity to serving string if available
      if(product.serving_size) document.getElementById('quantite').value = product.serving_size;
      else if(nutr.servingGrams) document.getElementById('quantite').value = nutr.servingGrams + ' g';
    } else {
      // Fill per 100g as default (user can change)
      document.getElementById('calories').value = Math.round(nutr.kcal_per_100g);
      document.getElementById('proteines').value = +(nutr.proteins_100g).toFixed(1);
      document.getElementById('glucides').value = +(nutr.carbs_100g).toFixed(1);
      document.getElementById('lipides').value = +(nutr.fats_100g).toFixed(1);
      // don't change quantity
    }
  }
}

/* Called when a barcode is detected */
let barcodeLookupInProgress = false;
async function onBarcodeDetected(barcode){
  if(!barcode) return;
  // avoid repeating lookup for same barcode while in progress
  if(barcode === lastScannedBarcode && barcodeLookupInProgress) return;
  lastScannedBarcode = barcode;
  barcodeLookupInProgress = true;

  // show immediate feedback
  const sr = document.getElementById('scanResult');
  sr.textContent = `Code d√©tect√© : ${barcode} ‚Äî recherche OpenFoodFacts‚Ä¶`;

  const r = await lookupBarcodeOpenFoodFacts(barcode);
  if(r && r.found && r.product){
    lastProduct = r.product;
    // update scanResult to show product name and brand
    const pname = r.product.product_name || r.product.generic_name || r.product.brands || 'Produit trouv√©';
    const brand = r.product.brands || '';
    sr.innerHTML = `<strong>${escapeHtml(pname)}</strong>${brand? ' ‚Äî ' + escapeHtml(brand):''}`;
    // prefill form with product data (user can still edit)
    applyProductToForm(r.product);
  } else {
    lastProduct = null;
    sr.textContent = `Produit non trouv√© pour le code ${barcode}`;
  }
  barcodeLookupInProgress = false;
}

/* small helper to escape HTML when inserting into innerHTML */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Render calendar */
function renderCalendar(){
  monthLabel.textContent = new Date(viewYear, viewMonth, 1).toLocaleDateString(undefined, {month:'long', year:'numeric'});
  daysGrid.innerHTML = '';
  const firstDay = new Date(viewYear, viewMonth, 1);
  const startIndex = (firstDay.getDay() + 6) % 7; // Monday = 0
  const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
  const prevMonthDays = startIndex;
  const prevMonthLastDate = new Date(viewYear, viewMonth, 0).getDate();
  const monthMarkers = daysWithMealsInMonth(viewYear, viewMonth);
  const totalCells = Math.ceil((prevMonthDays + daysInMonth) / 7) * 7;

  for(let i = 0; i < totalCells; i++){
    const cell = document.createElement('div');
    cell.className = 'day';
    let dayNum = i - prevMonthDays + 1;
    let cellDate = null;
    if(dayNum < 1){
      cell.classList.add('other');
      const num = prevMonthLastDate + dayNum;
      cell.textContent = num;
      const prevMonthDate = new Date(viewYear, viewMonth -1, num);
      cellDate = toISODate(prevMonthDate);
    } else if(dayNum > daysInMonth){
      cell.classList.add('other');
      const num = dayNum - daysInMonth;
      cell.textContent = num;
      const nextMonthDate = new Date(viewYear, viewMonth +1, num);
      cellDate = toISODate(nextMonthDate);
    } else {
      cell.textContent = dayNum;
      const d = new Date(viewYear, viewMonth, dayNum);
      cellDate = toISODate(d);
      if(cellDate === toISODate(new Date())) cell.classList.add('today');
      if(cellDate === selectedDate) cell.classList.add('selected');
      if(monthMarkers[cellDate]) cell.classList.add('has-meal');
    }

    cell.addEventListener('click', ()=>{
      const d = parseISO(cellDate);
      if(d.getFullYear() !== viewYear || d.getMonth() !== viewMonth){
        viewYear = d.getFullYear();
        viewMonth = d.getMonth();
        selectedDate = cellDate;
        selectedDateInput.value = selectedDate;
        renderCalendar();
        renderForSelectedDate();
      } else {
        selectedDate = cellDate;
        selectedDateInput.value = selectedDate;
        renderCalendar();
        renderForSelectedDate();
      }
    });

    daysGrid.appendChild(cell);
  }
}

/* Render for selectedDate */
function renderForSelectedDate(){
  selectedDateLabel.textContent = formatDateLabel(selectedDate);
  selectedDateLabelShort.textContent = selectedDate;
  const t = totalsForDate(selectedDate);

  totalMealsEl.textContent = t.count;
  totalCaloriesEl.textContent = Math.round(t.cal) + ' kcal';
  totalProteinesEl.textContent = Math.round(t.p) + ' g';
  totalGlucidesEl.textContent = Math.round(t.c) + ' g';

  statusCalories.textContent = Math.round(t.cal) + ' kcal';
  totalProteinesShort.textContent = Math.round(t.p) + ' g';
  totalGlucidesShort.textContent = Math.round(t.c) + ' g';
  totalProteinesShort2.textContent = Math.round(t.p) + ' g';
  totalGlucidesShort2.textContent = Math.round(t.c) + ' g';
  totalLipidesShort.textContent = Math.round(t.f) + ' g';
  dayTotalsShort.textContent = `${Math.round(t.cal)} kcal ‚Ä¢ ${Math.round(t.p)} g P ‚Ä¢ ${Math.round(t.c)} g C`;

  const percent = profile.goalCalories ? Math.min(100, Math.round((t.cal / profile.goalCalories) * 100)) : 0;
  progressBar.style.width = percent + '%';
  percentReached.textContent = `${Math.round(t.cal)} / ${profile.goalCalories} kcal`;

  // update dashboard progress
  if(dashboardProgress){
    dashboardProgress.style.width = percent + '%';
    dashboardPercent.textContent = `${Math.round(t.cal)} / ${profile.goalCalories} kcal`;
  }

  const items = meals.filter(m => m.date === selectedDate);
  mealsContainer.innerHTML = '';
  if(items.length === 0){
    emptyState.style.display = 'block';
  } else {
    emptyState.style.display = 'none';
    items.forEach((m, idx)=>{
      const div = document.createElement('div'); div.className = 'meal-item';
      const left = document.createElement('div'); left.className = 'meal-left';
      const av = document.createElement('div'); av.className = 'avatar'; av.textContent = (m.aliment||'').split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
      const meta = document.createElement('div'); meta.className = 'meal-meta';
      const title = document.createElement('strong'); title.textContent = `${m.categorie} ‚Ä¢ ${m.aliment}`;
      const sub = document.createElement('small'); sub.textContent = `${m.quantite||''} ‚Ä¢ ${Math.round(m.calories||0)} kcal ‚Ä¢ ${Math.round(m.proteines||0)} g P`;
      meta.appendChild(title); meta.appendChild(sub);
      left.appendChild(av); left.appendChild(meta);

      const actions = document.createElement('div'); actions.className = 'meal-actions';
      const edit = document.createElement('button'); edit.className = 'icon-btn'; edit.title='Modifier'; edit.innerHTML = '‚úé';
      edit.addEventListener('click', ()=> populateFormForEdit(getGlobalIndexOfMeal(m)));
      const del = document.createElement('button'); del.className = 'icon-btn del'; del.title='Supprimer'; del.innerHTML = 'üóë';
      del.addEventListener('click', ()=> {
        if(confirm(`Supprimer "${m.aliment}" ?`)){
          const gidx = getGlobalIndexOfMeal(m);
          if(gidx >= 0){
            meals.splice(gidx,1);
            saveMeals();
            renderCalendar();
            renderForSelectedDate();
          }
        }
      });
      actions.appendChild(edit); actions.appendChild(del);

      div.appendChild(left); div.appendChild(actions);
      mealsContainer.appendChild(div);
    });
  }
}

/* Find global index of meal */
function getGlobalIndexOfMeal(meal){
  let idx = meals.indexOf(meal);
  if(idx >= 0) return idx;
  for(let i=0;i<meals.length;i++){
    const m = meals[i];
    if(m.date === meal.date && m.aliment === meal.aliment && m.quantite === meal.quantite && Number(m.calories) === Number(meal.calories) && Number(m.proteines) === Number(meal.proteines)) return i;
  }
  return -1;
}

/* Edit handling */
let editingIndex = -1;
function populateFormForEdit(globalIndex){
  const m = meals[globalIndex];
  document.getElementById('aliment').value = m.aliment || '';
  document.getElementById('categorie').value = m.categorie || 'Plat';
  document.getElementById('quantite').value = m.quantite || '';
  document.getElementById('calories').value = m.calories ?? '';
  document.getElementById('proteines').value = m.proteines ?? '';
  document.getElementById('glucides').value = m.glucides ?? '';
  document.getElementById('lipides').value = m.lipides ?? '';
  selectedDate = m.date || selectedDate;
  selectedDateInput.value = selectedDate;
  const d = parseISO(selectedDate);
  viewYear = d.getFullYear(); viewMonth = d.getMonth();
  renderCalendar();
  renderForSelectedDate();
  addBtn.textContent = 'Enregistrer';
  editingIndex = globalIndex;
}

/* Submit form */
mealForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const meal = {
    date: selectedDate,
    categorie: document.getElementById('categorie').value || 'Plat',
    aliment: document.getElementById('aliment').value.trim() || 'Aliment',
    quantite: document.getElementById('quantite').value.trim() || '',
    calories: Number(document.getElementById('calories').value) || 0,
    proteines: Number(document.getElementById('proteines').value) || 0,
    glucides: Number(document.getElementById('glucides').value) || 0,
    lipides: Number(document.getElementById('lipides').value) || 0
  };
  if(editingIndex >= 0){
    meals[editingIndex] = meal;
    editingIndex = -1;
    addBtn.textContent = 'Ajouter';
  } else {
    meals.push(meal);
  }
  saveMeals();
  renderCalendar();
  renderForSelectedDate();
  mealForm.reset();
});

/* Clear form */
clearBtn.addEventListener('click', ()=>{
  mealForm.reset();
  editingIndex = -1;
  addBtn.textContent = 'Ajouter';
});

/* Date input change */
selectedDateInput.addEventListener('change', (e)=>{
  selectedDate = e.target.value;
  const d = parseISO(selectedDate);
  viewYear = d.getFullYear(); viewMonth = d.getMonth();
  renderCalendar();
  renderForSelectedDate();
});

/* Today button */
document.getElementById('todayBtn').addEventListener('click', ()=>{
  selectedDate = toISODate(new Date());
  selectedDateInput.value = selectedDate;
  const d = parseISO(selectedDate);
  viewYear = d.getFullYear(); viewMonth = d.getMonth();
  renderCalendar();
  renderForSelectedDate();
  window.scrollTo({top:0,behavior:'smooth'});
});

/* Calendar nav */
prevMonthBtn.addEventListener('click', ()=>{ viewMonth--; if(viewMonth < 0){ viewMonth = 11; viewYear--; } renderCalendar(); });
nextMonthBtn.addEventListener('click', ()=>{ viewMonth++; if(viewMonth > 11){ viewMonth = 0; viewYear++; } renderCalendar(); });

/* Navigation (nav icons restored behavior) */
document.querySelectorAll('.nav-item').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const page = btn.getAttribute('data-page');
    if(page === 'dashboard') document.getElementById('dashTitle').scrollIntoView({behavior:'smooth'});
    else if(page === 'add') document.getElementById('mealForm').scrollIntoView({behavior:'smooth', block:'center'});
    else if(page === 'scan') { openScannerModal && openScannerModal(); }
    else if(page === 'account') { window.location.href = 'account.html'; }
  });
});

/* Initialisation */
initSelectedDate();
renderCalendar();
renderForSelectedDate();

/* react to storage changes */
window.addEventListener('storage', (e)=>{
  if(e.key === PROFILE_KEY){
    try{ profile = Object.assign(profile, JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}')); }catch(e){}
    renderForSelectedDate();
  } else if(e.key === STORAGE_KEY){
    try{ meals = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){}
    renderCalendar();
    renderForSelectedDate();
  }
});

/* ---------- Barcode scanner logic using ZXing (with fallback) ---------- */
const scannerModal = document.getElementById('scannerModal');
const scannerVideo = document.getElementById('scannerVideo');
const openScannerBtn = document.getElementById('openScannerBtn');
const closeScannerBtn = document.getElementById('closeScannerBtn');
const startScannerBtn = document.getElementById('startScannerBtn');
const stopScannerBtn = document.getElementById('stopScannerBtn');
const videoSelect = document.getElementById('videoSelect');
const scanResult = document.getElementById('scanResult');
const useScanBtn = document.getElementById('useScanBtn');
const uploadBtn = document.getElementById('uploadBtn');
const uploadImage = document.getElementById('uploadImage');

let codeReader = null;
let currentStreamDeviceId = null;

function openScannerModal(){
  scannerModal.classList.add('active');
  scannerModal.setAttribute('aria-hidden','false');
  populateVideoDevices();
}
function closeScannerModal(){
  scannerModal.classList.remove('active');
  scannerModal.setAttribute('aria-hidden','true');
  stopScanning();
  scanResult.textContent = '‚Äî';
}

openScannerBtn.addEventListener('click', openScannerModal);
closeScannerBtn.addEventListener('click', closeScannerModal);

async function populateVideoDevices(){
  videoSelect.innerHTML = '';
  try{
    const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
    if(devices && devices.length){
      devices.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `Camera ${videoSelect.length+1}`;
        videoSelect.appendChild(opt);
      });
    } else {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Cam√©ra par d√©faut';
      videoSelect.appendChild(opt);
    }
  }catch(err){
    console.warn('Could not list devices', err);
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'Cam√©ra par d√©faut';
    videoSelect.appendChild(opt);
  }
}

startScannerBtn.addEventListener('click', async ()=>{
  await startScanning();
});
stopScannerBtn.addEventListener('click', ()=> {
  stopScanning();
});

async function startScanning(){
  // create reader if needed
  if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
  scanResult.textContent = '‚Ä¶Recherche en cours';
  const deviceId = videoSelect.value || null;
  currentStreamDeviceId = deviceId;
  try{
    // decodeFromVideoDevice will stream to video and call callback on detection
    await codeReader.decodeFromVideoDevice(deviceId, scannerVideo, (result, err) => {
      if(result){
        // got barcode
        // call our handler which does OpenFoodFacts lookup and UI updates
        onBarcodeDetected(result.text);
        // stop scanning after first result
        try{ codeReader.reset(); }catch(e){}
      }
      if(err && !(err instanceof ZXing.NotFoundException)){
        // other errors can be logged
        console.warn(err);
      }
    });
  }catch(e){
    console.error('Scanner start failed', e);
    scanResult.textContent = 'Impossible d\'acc√©der √† la cam√©ra';
  }
}

function stopScanning(){
  if(codeReader){
    try{ codeReader.reset(); }catch(e){}
  }
  // stop any tracks on video element
  try{
    const stream = scannerVideo.srcObject;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      scannerVideo.srcObject = null;
    }
  }catch(e){ /* ignore */ }
}

/* Use scan result to fill aliment input (button) */
useScanBtn.addEventListener('click', ()=>{
  if(lastProduct){
    // product found: ensure form pre-filled (applyProductToForm already did), just focus aliment
    document.getElementById('aliment').focus();
    closeScannerModal();
  } else {
    // fallback: insert raw barcode into aliment field
    const text = lastScannedBarcode || (scanResult.textContent && scanResult.textContent !== '‚Äî' ? scanResult.textContent : '');
    if(!text) return alert('Aucun code d√©tect√©');
    document.getElementById('aliment').value = text;
    closeScannerModal();
  }
});

/* fallback: scan from uploaded image file */
uploadBtn.addEventListener('click', ()=> uploadImage.click());
uploadImage.addEventListener('change', async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  scanResult.textContent = 'Analyse de l\'image‚Ä¶';
  try{
    // use ZXing to decode from image
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    await img.decode();
    // ZXing UMD provides a decodeFromImage API via BrowserMultiFormatReader
    if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
    codeReader.decodeFromImage(img).then(result=>{
      // call same handler so we lookup product
      onBarcodeDetected(result.text);
      useScanBtn.focus();
      URL.revokeObjectURL(img.src);
    }).catch(err=>{
      console.warn('Decode image failed', err);
      scanResult.textContent = 'Aucun code d√©tect√© dans l\'image';
      URL.revokeObjectURL(img.src);
    });
  }catch(e){
    console.error(e);
    scanResult.textContent = 'Erreur lors du traitement de l\'image';
  }
});

/* If user navigates away or closes modal, ensure camera stops */
window.addEventListener('beforeunload', ()=> stopScanning());

// Remplacement de l'emoji "üçû" (brioche) par "üç¨" (sucre) dans la summary-grid
// (dans le HTML)
document.querySelectorAll('.summary-item .icon').forEach(function(iconEl){
  if(iconEl.textContent.trim() === 'üçû') iconEl.textContent = 'üç¨';
});

// --- Suggestion de plats lors de la saisie ---
// Liste d'exemples de plats (√† enrichir selon besoin)
const platsExemples = [
  "Poulet r√¥ti", "Riz basmati", "Saumon grill√©", "P√¢tes carbonara", "Salade C√©sar", "Tajine de l√©gumes", "Couscous", "Boeuf bourguignon", "Ratatouille", "Tarte aux pommes", "Quiche lorraine", "Omelette nature", "Gratin dauphinois", "Lasagnes", "Chili con carne", "Poisson pan√©", "Soupe de l√©gumes", "Pizza margherita", "Burger maison", "Sushi saumon", "Curry de pois chiches", "Blanquette de veau", "Pa√´lla", "Tartiflette", "Croque-monsieur", "Wok de crevettes", "Poulet curry coco", "G√¢teau au chocolat"
];

platsExemples.push(
  "Saucisse grill√©e", "P√¢tes au saumon", "Poulet basquaise", "Tartare de boeuf", "Boulettes de viande", "Riz cantonais", "Gratin de courgettes", "Cordon bleu", "Steak hach√©", "Po√™l√©e de l√©gumes", "Taboul√©", "Salade de p√¢tes", "Moussaka", "Poulet tikka masala", "Boeuf Stroganoff", "R√¥ti de porc", "C√¥te de boeuf", "Poisson blanc vapeur", "Crevettes saut√©es", "Tarte sal√©e", "Soupe miso", "Gnocchis", "Raviolis ricotta √©pinards", "Boudin noir", "Choucroute", "Galette de sarrasin", "Tartine avocat", "Wrap poulet", "Bowl v√©g√©tarien", "Salade grecque", "Tarte au thon"
);

// Cr√©ation de la liste de suggestions
let suggestionBox = document.getElementById('suggestionBox');
if(!suggestionBox){
  suggestionBox = document.createElement('div');
  suggestionBox.id = 'suggestionBox';
  suggestionBox.style.position = 'absolute';
  suggestionBox.style.background = '#fff';
  suggestionBox.style.border = '1px solid #e0f3ef';
  suggestionBox.style.borderRadius = '10px';
  suggestionBox.style.boxShadow = '0 4px 16px rgba(21,183,154,0.08)';
  suggestionBox.style.zIndex = 100;
  suggestionBox.style.display = 'none';
  suggestionBox.style.maxHeight = '180px';
  suggestionBox.style.overflowY = 'auto';
  suggestionBox.style.minWidth = '220px';
  suggestionBox.style.fontSize = '15px';
  suggestionBox.style.padding = '4px 0';
  document.body.appendChild(suggestionBox);
}

const alimentInput = document.getElementById('aliment');
alimentInput.addEventListener('input', function(e){
  const val = alimentInput.value.trim().toLowerCase();
  if(val.length < 2){ suggestionBox.style.display = 'none'; return; }
  const matches = platsExemples.filter(p => p.toLowerCase().includes(val));
  if(matches.length === 0){ suggestionBox.style.display = 'none'; return; }
  suggestionBox.innerHTML = '';
  matches.forEach(plat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.padding = '8px 14px';
    row.style.cursor = 'pointer';
    // Nom du plat
    const nameSpan = document.createElement('span');
    nameSpan.textContent = plat;
    // Valeurs nutritionnelles
    const nutri = valeursNutriMoyennes[plat];
    const nutriSpan = document.createElement('span');
    nutriSpan.style.fontSize = '12px';
    nutriSpan.style.color = '#15b79a';
    nutriSpan.style.marginLeft = '10px';
    if(nutri){
      nutriSpan.textContent = `${nutri.cal}kcal | ${nutri.p}g P | ${nutri.c}g C | ${nutri.f}g L`;
    } else {
      nutriSpan.textContent = '';
    }
    // Quantit√© moyenne
    const qtyMoy = quantiteMoyenne[plat] || '';
    const qtyMoySpan = document.createElement('span');
    qtyMoySpan.style.fontSize = '12px';
    qtyMoySpan.style.color = '#6c7780';
    qtyMoySpan.style.marginLeft = '10px';
    qtyMoySpan.textContent = qtyMoy ? `~${qtyMoy}/pers` : '';
    // Champ quantit√© par personne
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '1';
    qtyInput.placeholder = 'Qt√©/pers';
    qtyInput.style.width = '70px';
    qtyInput.style.marginLeft = '10px';
    qtyInput.style.borderRadius = '7px';
    qtyInput.style.border = '1px solid #e0f3ef';
    qtyInput.style.padding = '4px 6px';
    qtyInput.style.fontSize = '14px';
    row.appendChild(nameSpan);
    row.appendChild(nutriSpan);
    row.appendChild(qtyMoySpan);
    row.appendChild(qtyInput);
    row.addEventListener('mousedown', function(ev){
      alimentInput.value = plat;
      if(qtyInput.value) document.getElementById('quantite').value = qtyInput.value + ' g';
      else if(qtyMoy) document.getElementById('quantite').value = qtyMoy;
      // Remplir les valeurs nutritionnelles si dispo
      if(nutri){
        document.getElementById('calories').value = nutri.cal;
        document.getElementById('proteines').value = nutri.p;
        document.getElementById('glucides').value = nutri.c;
        document.getElementById('lipides').value = nutri.f;
        lastPlatSelection = plat;
        lastNutriBase = nutri;
        let base = 100;
        if(qtyMoy && qtyMoy.match(/\d+/)) base = parseFloat(qtyMoy);
        lastQtyBase = base;
      } else {
        lastPlatSelection = null;
        lastNutriBase = null;
        lastQtyBase = null;
      }
      suggestionBox.style.display = 'none';
    });
    suggestionBox.appendChild(row);
  });
  // Positionnement sous l'input
  const rect = alimentInput.getBoundingClientRect();
  suggestionBox.style.left = rect.left + window.scrollX + 'px';
  suggestionBox.style.top = (rect.bottom + window.scrollY + 2) + 'px';
  suggestionBox.style.display = 'block';
});
// Masquer la box si on clique ailleurs
document.addEventListener('mousedown', function(e){
  if(!suggestionBox.contains(e.target) && e.target !== alimentInput){
    suggestionBox.style.display = 'none';
  }
});

// --- Ajout valeurs nutritionnelles moyennes pour suggestions de plats ---
// Dictionnaire de valeurs nutritionnelles moyennes (pour 100g ou par portion standard)
const valeursNutriMoyennes = {
  "Poulet r√¥ti": {cal: 165, p: 31, c: 0, f: 4},
  "Riz basmati": {cal: 130, p: 2.7, c: 28, f: 0.3},
  "Saumon grill√©": {cal: 206, p: 22, c: 0, f: 13},
  "P√¢tes carbonara": {cal: 180, p: 7, c: 22, f: 7},
  "Salade C√©sar": {cal: 120, p: 5, c: 6, f: 8},
  "Tajine de l√©gumes": {cal: 80, p: 2, c: 13, f: 2},
  "Couscous": {cal: 110, p: 3.5, c: 23, f: 0.2},
  "Boeuf bourguignon": {cal: 140, p: 13, c: 3, f: 8},
  "Ratatouille": {cal: 45, p: 1, c: 7, f: 2},
  "Tarte aux pommes": {cal: 180, p: 2, c: 30, f: 6},
  "Quiche lorraine": {cal: 220, p: 8, c: 17, f: 14},
  "Omelette nature": {cal: 150, p: 10, c: 1, f: 12},
  "Gratin dauphinois": {cal: 120, p: 2, c: 15, f: 6},
  "Lasagnes": {cal: 140, p: 7, c: 15, f: 6},
  "Chili con carne": {cal: 120, p: 7, c: 13, f: 4},
  "Poisson pan√©": {cal: 180, p: 12, c: 15, f: 8},
  "Soupe de l√©gumes": {cal: 40, p: 1, c: 7, f: 1},
  "Pizza margherita": {cal: 220, p: 8, c: 30, f: 7},
  "Burger maison": {cal: 250, p: 13, c: 24, f: 11},
  "Sushi saumon": {cal: 130, p: 6, c: 22, f: 2},
  "Curry de pois chiches": {cal: 140, p: 5, c: 20, f: 4},
  "Blanquette de veau": {cal: 120, p: 10, c: 3, f: 7},
  "Pa√´lla": {cal: 140, p: 7, c: 18, f: 4},
  "Tartiflette": {cal: 180, p: 7, c: 15, f: 10},
  "Croque-monsieur": {cal: 220, p: 10, c: 22, f: 10},
  "Wok de crevettes": {cal: 90, p: 10, c: 7, f: 3},
  "Poulet curry coco": {cal: 150, p: 10, c: 7, f: 8},
  "G√¢teau au chocolat": {cal: 350, p: 5, c: 45, f: 16}
};

// Ajout affichage valeurs nutritionnelles dans la suggestion
alimentInput.addEventListener('input', function(e){
  const val = alimentInput.value.trim().toLowerCase();
  if(val.length < 2){ suggestionBox.style.display = 'none'; return; }
  const matches = platsExemples.filter(p => p.toLowerCase().includes(val));
  if(matches.length === 0){ suggestionBox.style.display = 'none'; return; }
  suggestionBox.innerHTML = '';
  matches.forEach(plat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.padding = '8px 14px';
    row.style.cursor = 'pointer';
    // Nom du plat
    const nameSpan = document.createElement('span');
    nameSpan.textContent = plat;
    // Valeurs nutritionnelles
    const nutri = valeursNutriMoyennes[plat];
    const nutriSpan = document.createElement('span');
    nutriSpan.style.fontSize = '12px';
    nutriSpan.style.color = '#15b79a';
    nutriSpan.style.marginLeft = '10px';
    if(nutri){
      nutriSpan.textContent = `${nutri.cal}kcal | ${nutri.p}g P | ${nutri.c}g C | ${nutri.f}g L`;
    } else {
      nutriSpan.textContent = '';
    }
    // Quantit√© moyenne
    const qtyMoy = quantiteMoyenne[plat] || '';
    const qtyMoySpan = document.createElement('span');
    qtyMoySpan.style.fontSize = '12px';
    qtyMoySpan.style.color = '#6c7780';
    qtyMoySpan.style.marginLeft = '10px';
    qtyMoySpan.textContent = qtyMoy ? `~${qtyMoy}/pers` : '';
    // Champ quantit√© par personne
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '1';
    qtyInput.placeholder = 'Qt√©/pers';
    qtyInput.style.width = '70px';
    qtyInput.style.marginLeft = '10px';
    qtyInput.style.borderRadius = '7px';
    qtyInput.style.border = '1px solid #e0f3ef';
    qtyInput.style.padding = '4px 6px';
    qtyInput.style.fontSize = '14px';
    row.appendChild(nameSpan);
    row.appendChild(nutriSpan);
    row.appendChild(qtyMoySpan);
    row.appendChild(qtyInput);
    row.addEventListener('mousedown', function(ev){
      alimentInput.value = plat;
      if(qtyInput.value) document.getElementById('quantite').value = qtyInput.value + ' g';
      else if(qtyMoy) document.getElementById('quantite').value = qtyMoy;
      // Remplir les valeurs nutritionnelles si dispo
      if(nutri){
        document.getElementById('calories').value = nutri.cal;
        document.getElementById('proteines').value = nutri.p;
        document.getElementById('glucides').value = nutri.c;
        document.getElementById('lipides').value = nutri.f;
      }
      suggestionBox.style.display = 'none';
    });
    suggestionBox.appendChild(row);
  });
  // Positionnement sous l'input
  const rect = alimentInput.getBoundingClientRect();
  suggestionBox.style.left = rect.left + window.scrollX + 'px';
  suggestionBox.style.top = (rect.bottom + window.scrollY + 2) + 'px';
  suggestionBox.style.display = 'block';
});

// Ajout quantit√© moyenne par personne pour chaque plat
const quantiteMoyenne = {
  "Poulet r√¥ti": "150 g",
  "Riz basmati": "180 g",
  "Saumon grill√©": "120 g",
  "P√¢tes carbonara": "250 g",
  "Salade C√©sar": "220 g",
  "Tajine de l√©gumes": "250 g",
  "Couscous": "200 g",
  "Boeuf bourguignon": "200 g",
  "Ratatouille": "200 g",
  "Tarte aux pommes": "100 g",
  "Quiche lorraine": "120 g",
  "Omelette nature": "110 g",
  "Gratin dauphinois": "180 g",
  "Lasagnes": "200 g",
  "Chili con carne": "220 g",
  "Poisson pan√©": "100 g",
  "Soupe de l√©gumes": "300 ml",
  "Pizza margherita": "150 g",
  "Burger maison": "200 g",
  "Sushi saumon": "6 pi√®ces",
  "Curry de pois chiches": "200 g",
  "Blanquette de veau": "200 g",
  "Pa√´lla": "250 g",
  "Tartiflette": "220 g",
  "Croque-monsieur": "1 pi√®ce",
  "Wok de crevettes": "180 g",
  "Poulet curry coco": "200 g",
  "G√¢teau au chocolat": "80 g"
};

// Ajout affichage quantit√© moyenne dans la suggestion
alimentInput.addEventListener('input', function(e){
  const val = alimentInput.value.trim().toLowerCase();
  if(val.length < 2){ suggestionBox.style.display = 'none'; return; }
  const matches = platsExemples.filter(p => p.toLowerCase().includes(val));
  if(matches.length === 0){ suggestionBox.style.display = 'none'; return; }
  suggestionBox.innerHTML = '';
  matches.forEach(plat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.padding = '8px 14px';
    row.style.cursor = 'pointer';
    // Nom du plat
    const nameSpan = document.createElement('span');
    nameSpan.textContent = plat;
    // Valeurs nutritionnelles
    const nutri = valeursNutriMoyennes[plat];
    const nutriSpan = document.createElement('span');
    nutriSpan.style.fontSize = '12px';
    nutriSpan.style.color = '#15b79a';
    nutriSpan.style.marginLeft = '10px';
    if(nutri){
      nutriSpan.textContent = `${nutri.cal}kcal | ${nutri.p}g P | ${nutri.c}g C | ${nutri.f}g L`;
    } else {
      nutriSpan.textContent = '';
    }
    // Quantit√© moyenne
    const qtyMoy = quantiteMoyenne[plat] || '';
    const qtyMoySpan = document.createElement('span');
    qtyMoySpan.style.fontSize = '12px';
    qtyMoySpan.style.color = '#6c7780';
    qtyMoySpan.style.marginLeft = '10px';
    qtyMoySpan.textContent = qtyMoy ? `~${qtyMoy}/pers` : '';
    // Champ quantit√© par personne
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '1';
    qtyInput.placeholder = 'Qt√©/pers';
    qtyInput.style.width = '70px';
    qtyInput.style.marginLeft = '10px';
    qtyInput.style.borderRadius = '7px';
    qtyInput.style.border = '1px solid #e0f3ef';
    qtyInput.style.padding = '4px 6px';
    qtyInput.style.fontSize = '14px';
    row.appendChild(nameSpan);
    row.appendChild(nutriSpan);
    row.appendChild(qtyMoySpan);
    row.appendChild(qtyInput);
    row.addEventListener('mousedown', function(ev){
      alimentInput.value = plat;
      if(qtyInput.value) document.getElementById('quantite').value = qtyInput.value + ' g';
      else if(qtyMoy) document.getElementById('quantite').value = qtyMoy;
      // Remplir les valeurs nutritionnelles si dispo
      if(nutri){
        document.getElementById('calories').value = nutri.cal;
        document.getElementById('proteines').value = nutri.p;
        document.getElementById('glucides').value = nutri.c;
        document.getElementById('lipides').value = nutri.f;
        lastPlatSelection = plat;
        lastNutriBase = nutri;
        let base = 100;
        if(qtyMoy && qtyMoy.match(/\d+/)) base = parseFloat(qtyMoy);
        lastQtyBase = base;
      } else {
        lastPlatSelection = null;
        lastNutriBase = null;
        lastQtyBase = null;
      }
      suggestionBox.style.display = 'none';
    });
    suggestionBox.appendChild(row);
  });
  // Positionnement sous l'input
  const rect = alimentInput.getBoundingClientRect();
  suggestionBox.style.left = rect.left + window.scrollX + 'px';
  suggestionBox.style.top = (rect.bottom + window.scrollY + 2) + 'px';
  suggestionBox.style.display = 'block';
});

// --- Centrage des totaux dans la summary-grid ---
const style2 = document.createElement('style');
style2.textContent = `
  .summary-grid { justify-items: center; align-items: center; }
  .summary-item { align-items: center; text-align: center; }
`;
document.head.appendChild(style2);

// --- Brand header esth√©tique ---
const styleBrand = document.createElement('style');
styleBrand.textContent = `
  .brand {
    background: linear-gradient(90deg, #e6f9f4 60%, #fafdff 100%);
    border-radius: 18px;
    box-shadow: 0 4px 24px rgba(21,183,154,0.10);
    padding: 10px 22px 10px 10px;
    align-items: center;
    gap: 18px;
    margin-bottom: 10px;
    border: 1.5px solid #e0f3ef;
    position: relative;
  }
  .brand .logo {
    width: 62px;
    height: 62px;
    border-radius: 16px;
    background: linear-gradient(135deg,#15b79a 60%,#0f9e85 100%);
    box-shadow: 0 2px 12px rgba(21,183,154,0.13);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0;
  }
  .brand .logo img {
    width: 54px;
    height: 54px;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(21,183,154,0.10);
  }
  .brand h1 {
    font-size: 22px;
    font-weight: 700;
    color: #15b79a;
    margin-bottom: 2px;
  }
  .brand .hint, .brand p.lead {
    color: #0f9e85;
    font-size: 14px;
    margin: 0;
    font-weight: 500;
  }
`;
document.head.appendChild(styleBrand);

// --- summary-item largeur √©gale ---
const styleSummary = document.createElement('style');
styleSummary.textContent = `
  .summary-grid { grid-template-columns: repeat(4, 1fr) !important; }
  .summary-item { min-width: 0; width: 100%; max-width: 100%; flex: 1 1 0; box-sizing: border-box; }
`;
document.head.appendChild(styleSummary);

// --- Sauvegarde des repas sur Firebase (robuste, non bloquant) ---
(async function(){
  try {
    const [{ initializeApp, getApps }, { getAuth, signInAnonymously, onAuthStateChanged }, { getFirestore, collection, addDoc, serverTimestamp }] = await Promise.all([
      import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js'),
      import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js'),
      import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js')
    ]);
    const firebaseConfig = {
      apiKey: "AIzaSyC_3k3stpYt3R6ysGOqRUw6UAk-ePYaUCM",
      authDomain: "appp-6ead3.firebaseapp.com",
      projectId: "appp-6ead3"
    };
    let fbApp, fbAuth, fbDb, fbUid;
    if (!getApps().length) {
      fbApp = initializeApp(firebaseConfig);
    } else {
      fbApp = getApps()[0];
    }
    fbAuth = getAuth(fbApp);
    fbDb = getFirestore(fbApp);
    onAuthStateChanged(fbAuth, (user) => { if(user) fbUid = user.uid; });
    await signInAnonymously(fbAuth);
    mealForm.addEventListener('submit', async (e)=>{
      if(fbUid && fbDb){
        try{
          const meal = {
            date: selectedDate,
            categorie: document.getElementById('categorie').value || 'Plat',
            aliment: document.getElementById('aliment').value.trim() || 'Aliment',
            quantite: document.getElementById('quantite').value.trim() || '',
            calories: Number(document.getElementById('calories').value) || 0,
            proteines: Number(document.getElementById('proteines').value) || 0,
            glucides: Number(document.getElementById('glucides').value) || 0,
            lipides: Number(document.getElementById('lipides').value) || 0,
            createdAt: serverTimestamp()
          };
          await addDoc(collection(fbDb, "users", fbUid, "meals"), meal);
        }catch(e){
          // Ne bloque pas l'ajout local
          console.warn('Erreur Firestore (non bloquant):', e);
        }
      }
    });
  } catch(e){
    // Firebase indisponible, on ne fait rien
    console.warn('Firebase non initialis√© (non bloquant)', e);
  }
})();

// Ajout des valeurs nutritionnelles pour les nouveaux plats
Object.assign(valeursNutriMoyennes, {
  "Saucisse grill√©e": {cal: 290, p: 13, c: 2, f: 26},
  "P√¢tes au saumon": {cal: 180, p: 8, c: 25, f: 6},
  "Poulet basquaise": {cal: 110, p: 13, c: 4, f: 4},
  "Tartare de boeuf": {cal: 160, p: 19, c: 0, f: 9},
  "Boulettes de viande": {cal: 210, p: 14, c: 7, f: 14},
  "Riz cantonais": {cal: 140, p: 6, c: 22, f: 3},
  "Gratin de courgettes": {cal: 90, p: 4, c: 7, f: 5},
  "Cordon bleu": {cal: 220, p: 13, c: 10, f: 13},
  "Steak hach√©": {cal: 210, p: 18, c: 0, f: 15},
  "Po√™l√©e de l√©gumes": {cal: 60, p: 2, c: 8, f: 2},
  "Taboul√©": {cal: 120, p: 3, c: 20, f: 3},
  "Salade de p√¢tes": {cal: 130, p: 4, c: 22, f: 3},
  "Moussaka": {cal: 110, p: 5, c: 8, f: 7},
  "Poulet tikka masala": {cal: 140, p: 11, c: 6, f: 7},
  "Boeuf Stroganoff": {cal: 130, p: 10, c: 4, f: 8},
  "R√¥ti de porc": {cal: 180, p: 22, c: 0, f: 10},
  "C√¥te de boeuf": {cal: 220, p: 19, c: 0, f: 16},
  "Poisson blanc vapeur": {cal: 90, p: 18, c: 0, f: 1},
  "Crevettes saut√©es": {cal: 110, p: 18, c: 1, f: 4},
  "Tarte sal√©e": {cal: 210, p: 7, c: 18, f: 13},
  "Soupe miso": {cal: 40, p: 3, c: 4, f: 1},
  "Gnocchis": {cal: 140, p: 3, c: 28, f: 1},
  "Raviolis ricotta √©pinards": {cal: 160, p: 6, c: 25, f: 4},
  "Boudin noir": {cal: 325, p: 14, c: 8, f: 28},
  "Choucroute": {cal: 120, p: 8, c: 6, f: 7},
  "Galette de sarrasin": {cal: 120, p: 5, c: 20, f: 2},
  "Tartine avocat": {cal: 160, p: 4, c: 18, f: 8},
  "Wrap poulet": {cal: 180, p: 10, c: 22, f: 6},
  "Bowl v√©g√©tarien": {cal: 110, p: 5, c: 18, f: 2},
  "Salade grecque": {cal: 90, p: 4, c: 5, f: 6},
  "Tarte au thon": {cal: 180, p: 10, c: 15, f: 9}
});
Object.assign(quantiteMoyenne, {
  "Saucisse grill√©e": "80 g",
  "P√¢tes au saumon": "250 g",
  "Poulet basquaise": "220 g",
  "Tartare de boeuf": "150 g",
  "Boulettes de viande": "120 g",
  "Riz cantonais": "200 g",
  "Gratin de courgettes": "180 g",
  "Cordon bleu": "110 g",
  "Steak hach√©": "100 g",
  "Po√™l√©e de l√©gumes": "200 g",
  "Taboul√©": "180 g",
  "Salade de p√¢tes": "200 g",
  "Moussaka": "200 g",
  "Poulet tikka masala": "200 g",
  "Boeuf Stroganoff": "180 g",
  "R√¥ti de porc": "120 g",
  "C√¥te de boeuf": "200 g",
  "Poisson blanc vapeur": "120 g",
  "Crevettes saut√©es": "100 g",
  "Tarte sal√©e": "100 g",
  "Soupe miso": "250 ml",
  "Gnocchis": "180 g",
  "Raviolis ricotta √©pinards": "180 g",
  "Boudin noir": "80 g",
  "Choucroute": "250 g",
  "Galette de sarrasin": "1 pi√®ce",
  "Tartine avocat": "1 tranche",
  "Wrap poulet": "1 pi√®ce",
  "Bowl v√©g√©tarien": "250 g",
  "Salade grecque": "180 g",
  "Tarte au thon": "100 g"
});

// Correction iOS zoom : font-size 16px sur tous les champs de formulaire
const styleIOS = document.createElement('style');
styleIOS.textContent = `
  input[type="text"], input[type="number"], select {
    font-size: 16px !important;
  }
`;
document.head.appendChild(styleIOS);

// --- Mise √† jour dynamique des valeurs nutritionnelles selon la quantit√© ---
let lastPlatSelection = null;
let lastNutriBase = null;
let lastQtyBase = null;
const quantiteInput = document.getElementById('quantite');
// Lors de la s√©lection d'un plat dans la suggestion
alimentInput.addEventListener('input', function(e){
  const val = alimentInput.value.trim().toLowerCase();
  if(val.length < 2){ suggestionBox.style.display = 'none'; return; }
  const matches = platsExemples.filter(p => p.toLowerCase().includes(val));
  if(matches.length === 0){ suggestionBox.style.display = 'none'; return; }
  suggestionBox.innerHTML = '';
  matches.forEach(plat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.padding = '8px 14px';
    row.style.cursor = 'pointer';
    // Nom du plat
    const nameSpan = document.createElement('span');
    nameSpan.textContent = plat;
    // Valeurs nutritionnelles
    const nutri = valeursNutriMoyennes[plat];
    const nutriSpan = document.createElement('span');
    nutriSpan.style.fontSize = '12px';
    nutriSpan.style.color = '#15b79a';
    nutriSpan.style.marginLeft = '10px';
    if(nutri){
      nutriSpan.textContent = `${nutri.cal}kcal | ${nutri.p}g P | ${nutri.c}g C | ${nutri.f}g L`;
    } else {
      nutriSpan.textContent = '';
    }
    // Quantit√© moyenne
    const qtyMoy = quantiteMoyenne[plat] || '';
    const qtyMoySpan = document.createElement('span');
    qtyMoySpan.style.fontSize = '12px';
    qtyMoySpan.style.color = '#6c7780';
    qtyMoySpan.style.marginLeft = '10px';
    qtyMoySpan.textContent = qtyMoy ? `~${qtyMoy}/pers` : '';
    // Champ quantit√© par personne
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = '1';
    qtyInput.placeholder = 'Qt√©/pers';
    qtyInput.style.width = '70px';
    qtyInput.style.marginLeft = '10px';
    qtyInput.style.borderRadius = '7px';
    qtyInput.style.border = '1px solid #e0f3ef';
    qtyInput.style.padding = '4px 6px';
    qtyInput.style.fontSize = '14px';
    row.appendChild(nameSpan);
    row.appendChild(nutriSpan);
    row.appendChild(qtyMoySpan);
    row.appendChild(qtyInput);
    row.addEventListener('mousedown', function(ev){
      alimentInput.value = plat;
      let q = qtyInput.value;
      if(!q && qtyMoy) q = qtyMoy.replace(/[^\d,.]/g, '');
      if(q) document.getElementById('quantite').value = qtyMoy || (q + ' g');
      else document.getElementById('quantite').value = '';
      if(nutri){
        document.getElementById('calories').value = nutri.cal;
        document.getElementById('proteines').value = nutri.p;
        document.getElementById('glucides').value = nutri.c;
        document.getElementById('lipides').value = nutri.f;
        lastPlatSelection = plat;
        lastNutriBase = nutri;
        let base = 100;
        if(qtyMoy && qtyMoy.match(/\d+/)) base = parseFloat(qtyMoy);
        lastQtyBase = base;
      } else {
        lastPlatSelection = null;
        lastNutriBase = null;
        lastQtyBase = null;
      }
      suggestionBox.style.display = 'none';
    });
    suggestionBox.appendChild(row);
  });
  const rect = alimentInput.getBoundingClientRect();
  suggestionBox.style.left = rect.left + window.scrollX + 'px';
  suggestionBox.style.top = (rect.bottom + window.scrollY + 2) + 'px';
  suggestionBox.style.display = 'block';
});
quantiteInput.addEventListener('input', function(){
  if(lastPlatSelection && lastNutriBase && lastQtyBase){
    let q = parseFloat(quantiteInput.value.replace(/[^\d,.]/g, '').replace(',', '.'));
    if(isNaN(q) || q <= 0) return;
    const ratio = q / lastQtyBase;
    document.getElementById('calories').value = Math.round(lastNutriBase.cal * ratio);
    document.getElementById('proteines').value = +(lastNutriBase.p * ratio).toFixed(1);
    document.getElementById('glucides').value = +(lastNutriBase.c * ratio).toFixed(1);
    document.getElementById('lipides').value = +(lastNutriBase.f * ratio).toFixed(1);
  }
});
alimentInput.addEventListener('input', function(){
  if(alimentInput.value !== lastPlatSelection){
    lastPlatSelection = null;
    lastNutriBase = null;
    lastQtyBase = null;
  }
});

// Remplissage auto des valeurs nutritionnelles depuis la base
const caloriesInput = document.getElementById('calories');
const proteinesInput = document.getElementById('proteines');
const glucidesInput = document.getElementById('glucides');
const lipidesInput = document.getElementById('lipides');

alimentInput.addEventListener('blur', function() {
  const val = alimentInput.value.trim().toLowerCase();
  if(!val) return;
  // Recherche dans la base ultra-compl√®te
  const plat = basePlatsComplet.find(p => p.nom.toLowerCase() === val);
  if(plat) {
    quantiteInput.value = plat.quantite;
    caloriesInput.value = plat.cal;
    proteinesInput.value = plat.p;
    glucidesInput.value = plat.c;
    lipidesInput.value = plat.f;
    document.getElementById('categorie').value = plat.categorie.charAt(0).toUpperCase() + plat.categorie.slice(1);
  }
});

// Suggestion dynamique depuis la base ultra-compl√®te
window.suggestionBox = window.suggestionBox || document.getElementById('suggestionBox');
if(!window.suggestionBox){
  window.suggestionBox = document.createElement('div');
  window.suggestionBox.id = 'suggestionBox';
  window.suggestionBox.style.position = 'absolute';
  window.suggestionBox.style.zIndex = '100';
  window.suggestionBox.style.background = '#fff';
  window.suggestionBox.style.border = '1px solid #e0f3ef';
  window.suggestionBox.style.borderRadius = '10px';
  window.suggestionBox.style.boxShadow = '0 2px 12px rgba(21,183,154,0.08)';
  window.suggestionBox.style.minWidth = '220px';
  window.suggestionBox.style.maxHeight = '320px';
  window.suggestionBox.style.overflowY = 'auto';
  window.suggestionBox.style.display = 'none';
  document.body.appendChild(window.suggestionBox);
}

alimentInput.addEventListener('input', function(e) {
  const val = alimentInput.value.trim().toLowerCase();
  if(val.length < 1) { window.suggestionBox.style.display = 'none'; return; }
  // Recherche dans toute la base
  const matches = basePlatsComplet.filter(p => p.nom.toLowerCase().includes(val));
  if(matches.length === 0) { window.suggestionBox.style.display = 'none'; return; }
  window.suggestionBox.innerHTML = '';
  matches.slice(0, 20).forEach(plat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.padding = '8px 14px';
    row.style.cursor = 'pointer';
    row.style.borderBottom = '1px solid #e0f3ef';
    row.innerHTML = `<span style='font-weight:500'>${plat.nom}</span> <span style='color:#15b79a;font-size:12px;margin-left:10px'>${plat.cal}kcal | ${plat.p}g P | ${plat.c}g C | ${plat.f}g L</span> <span style='color:#6c7780;font-size:12px;margin-left:10px'>${plat.quantite}</span> <span style='color:#6c7780;font-size:12px;margin-left:10px'>${plat.categorie}</span>`;
    row.addEventListener('mousedown', function(ev) {
      alimentInput.value = plat.nom;
      quantiteInput.value = plat.quantite;
      caloriesInput.value = plat.cal;
      proteinesInput.value = plat.p;
      glucidesInput.value = plat.c;
      lipidesInput.value = plat.f;
      document.getElementById('categorie').value = plat.categorie.charAt(0).toUpperCase() + plat.categorie.slice(1);
      window.suggestionBox.style.display = 'none';
    });
    window.suggestionBox.appendChild(row);
  });
  // Positionnement sous l'input
  const rect = alimentInput.getBoundingClientRect();
  window.suggestionBox.style.left = rect.left + window.scrollX + 'px';
  window.suggestionBox.style.top = (rect.bottom + window.scrollY + 2) + 'px';
  window.suggestionBox.style.display = 'block';
});
// Masquer la box si on clique ailleurs
 document.addEventListener('mousedown', function(e){
   if(!window.suggestionBox.contains(e.target) && e.target !== alimentInput){
     window.suggestionBox.style.display = 'none';
   }
 });
</script>
</body>
</html>
